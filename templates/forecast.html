<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>5-Tage-Vorhersage</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='forecast_style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <header>
    <h1>üå§Ô∏è Wettervorhersage</h1>
    <a href="/" class="button-link">üè† Zur√ºck zur Startseite</a>
    <button onclick="toggleDarkmode()" class="button-link">üåó Darkmode</button>
  </header>

  <main class="forecast-container">
    {% for city in forecastdata %}
      <section class="city-forecast">
        <h2>{{ city.city }}</h2>

        {% if city.forecasts %}
          <div class="symbolleiste">
            <h3>Wetterverlauf</h3>
            <div class="icons">
              {% set last_date = "" %}
              {% set last_day = "" %}
{% for entry in city.forecasts %}
  {% set current_day = entry.timestamp[:10] %}
  <div class="symbol-eintrag">
    {% if current_day != last_day %}
      <span class="wochentag">{{ current_day | datetimeformat('%A, %d.%m.') }}</span>
      {% set last_day = current_day %}
    {% else %}
      <span class="wochentag">&nbsp;</span>
    {% endif %}
    <img src="http://openweathermap.org/img/wn/{{ entry.icon }}@2x.png" alt="icon">
    <span class="uhrzeit">{{ entry.timestamp[11:16] }}</span>
  </div>
{% endfor %}
            </div>
          </div>

          <!-- Temperaturverlauf -->
          <canvas id="chart-{{ loop.index0 }}"></canvas>
        {% else %}
          <p class="error">‚ùóKeine Vorhersagedaten verf√ºgbar.</p>
        {% endif %}
      </section>
    {% endfor %}
  </main>

  <footer>
    <p>Quelle: OpenWeatherMap ‚Ä¢ Stand: {{ forecastdata[0].forecasts[0].timestamp if forecastdata and forecastdata[0].forecasts }}</p>
  </footer>

  <script id="forecast-json" type="application/json">
    {{ forecastdata | tojson | safe }}
  </script>

  <script>
    const forecastData = JSON.parse(document.getElementById("forecast-json").textContent);

    forecastData.forEach((city, index) => {
      const ctx = document.getElementById(`chart-${index}`).getContext("2d");

      const labels = city.forecasts.map(f => {
        const [date, time] = f.timestamp.split(" ");
        const [year, month, day] = date.split("-");
        return `${day}.${month} ${time.slice(0, 5)}`;
      });

      const temps = city.forecasts.map(f => f.temp);

      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: `üå°Ô∏è Temperatur in ${city.city}`,
            data: temps,
            borderColor: '#007BFF',
            backgroundColor: 'rgba(0, 123, 255, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: {
              ticks: { maxRotation: 45, minRotation: 45 },
              title: { display: false }
            },
            y: {
              title: { display: false }
            }
          }
        }
      });
    });

    // Darkmode beim Laden wiederherstellen
    if (localStorage.getItem("darkmode") === "true") {
      document.body.classList.add("darkmode");
    }

    // Toggle-Funktion
    function toggleDarkmode() {
      const isDark = document.body.classList.toggle("darkmode");
      document.documentElement.classList.toggle("darkmode", isDark);
      localStorage.setItem("darkmode", isDark);
    }
  </script>
</body>
</html>
