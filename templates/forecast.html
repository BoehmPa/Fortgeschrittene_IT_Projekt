<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>5-Tage-Vorhersage</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='forecast_style.css') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <h1>üå§Ô∏è Wettervorhersage</h1>
    <a href="/" class="button-link">üè† Zur√ºck zur Startseite</a>
    <button onclick="toggleDarkmode()" class="button-link">üåó Darkmode</button>
  </header>

  <main class="forecast-container">
    {% for city in forecastdata %}
      <section class="city-forecast">
        <h2>{{ city.city }}</h2>

        {% if city.forecasts %}
          <!-- Wetter-Symbole -->
          <div class="symbolleiste">
            <h3>Wetterverlauf</h3>
            <div class="icons">
              {% set last_day = "" %}
              {% for entry in city.forecasts %}
                {% set current_day = entry.timestamp[:10] %}
                <div class="symbol-eintrag">
                  {% if current_day != last_day %}
                    <span class="wochentag">{{ entry.timestamp[:10] | datetimeformat('%A, %d.%m.') }}</span> <!--hier wird das Template aus dem Backend verwendet-->
                    {% set last_day = current_day %}
                  {% else %}
                    <span class="wochentag">&nbsp;</span>
                  {% endif %}
                  <img src="http://openweathermap.org/img/wn/{{ entry.icon }}@2x.png" alt="icon">
                  <span class="uhrzeit">{{ entry.timestamp[11:16] }}</span>
                </div>
              {% endfor %}
            </div>
          </div>

          <!-- Temperatur-Chart -->
          <div class="chart-wrapper">
            <div class="chart-container">
              <canvas id="chart-{{ loop.index0 }}"></canvas>
            </div>
          </div>
        {% else %}
          <p class="error">‚ùóKeine Vorhersagedaten verf√ºgbar.</p>
        {% endif %}
      </section>
    {% endfor %}
  </main>

  <footer>
    <p>Quelle: OpenWeatherMap ‚Ä¢ Stand: {{ forecastdata[0].forecasts[0].timestamp if forecastdata and forecastdata[0].forecasts }}</p>
  </footer>

<!-- √úbergibt die forecastdata aus Flask in das HTML-Template als JSON -->
<script id="forecast-json" type="application/json">
    {{ forecastdata | tojson | safe }}
</script>

<script>
  // Holt den Inhalt des JSON-Skriptelements und parst ihn als JavaScript-Objekt
  const forecastData = JSON.parse(document.getElementById("forecast-json").textContent);

  // Iteriert √ºber alle St√§dte in den Wetterdaten
  forecastData.forEach((city, index) => {
    // Holt das Canvas-Element f√ºr das aktuelle Diagramm
    const ctx = document.getElementById(`chart-${index}`).getContext("2d");

    // Erstellt die X-Achsen-Beschriftungen im Format 'TT.MM HH:MM'
    const labels = city.forecasts.map(f => {
      const [date, time] = f.timestamp.split(" "); // z.B. "2025-05-24 15:00:00"
      const [year, month, day] = date.split("-");
      return `${day}.${month} ${time.slice(0, 5)}`; // "24.05 15:00"
    });

    // Holt die Temperaturwerte aus den Forecast-Eintr√§gen
    const temps = city.forecasts.map(f => f.temp);

    // Erstellt ein neues Liniendiagramm mit Chart.js
    new Chart(ctx, {
      type: 'line', // Diagrammtyp: Linie
      data: {
        labels: labels, // X-Achse: Zeitstempel
        datasets: [{
          label: `üå°Ô∏è Temperatur in ${city.city}`, // Legenden-Label (optional sichtbar)
          data: temps, // Y-Achse: Temperaturwerte
          borderColor: '#007BFF', // Linienfarbe
          backgroundColor: 'rgba(0, 123, 255, 0.1)', // F√ºllung unter der Linie
          fill: true,
          tension: 0.3, // Gl√§ttung der Linie
          pointRadius: 3 // Gr√∂√üe der Datenpunkte
        }]
      },
      options: {
        responsive: true, // Diagramm skaliert mit Fenstergr√∂√üe
        maintainAspectRatio: false, // Verh√§ltnis Breite/H√∂he wird ignoriert
        plugins: {
          legend: { display: false }, // Legende ausblenden
          tooltip: { mode: 'index', intersect: false } // Tooltips f√ºr alle Punkte bei Hover
        },
        scales: {
          x: {
            ticks: { maxRotation: 45, minRotation: 45 }, // X-Achsen-Beschriftungen leicht schr√§g
            title: { display: false }
          },
          y: {
            title: { display: false } // Keine Y-Achsenbeschriftung
          }
        }
      }
    });
  });

  // Stellt den Darkmode beim Laden automatisch wieder her, wenn er vorher aktiviert war
  if (localStorage.getItem("darkmode") === "true") {
    document.body.classList.add("darkmode");
    document.documentElement.classList.add("darkmode");
  }

  // Funktion zum Umschalten des Darkmode
  function toggleDarkmode() {
    const isDark = document.body.classList.toggle("darkmode"); // Klasse auf <body> umschalten
    document.documentElement.classList.toggle("darkmode", isDark); // Klasse auf <html> entsprechend setzen
    localStorage.setItem("darkmode", isDark); // Einstellung im Browser speichern
  }
</script>

</body>
</html>
