<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Wetterkarte</title>

  <!-- Eigene CSS-Datei für Karten-Layout -->
  <link rel="stylesheet" href="{{ url_for('static', filename='map_style.css') }}">

  <!-- Schriftart "Inter" für moderne Darstellung -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Leaflet-Kartenbibliothek (CSS) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>
  <!-- Kartencontainer mit Button zur Startseite -->
  <div class="map-container" id="mapContainer">
    <button class="homepage-button" onclick="window.location.href='/'">🏠 Zurück zur Startseite</button>
    <div id="map"></div>
  </div>
  <div class="overlay-controls">
  <button onclick="toggleOverlay('temp')">🌡️<br>Temp</button>
  <button onclick="toggleOverlay('clouds')">☁️<br>Wolken</button>
  <button onclick="toggleOverlay('precipitation')">🌧️<br>Regen</button>
  <button onclick="toggleOverlay('wind')">💨<br>Wind</button>
  </div>

  <!-- Leaflet-Kartenbibliothek (JS) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
  // Karte initialisieren und auf Deutschland zentrieren
  const map = L.map('map').setView([51.1657, 10.4515], 5);
  const apiKey = "{{ api_key }}"; // API-Key aus dem Backend laden

  // Begrenzung setzen – verhindert Verschieben aus dem Weltbereich
  map.setMaxBounds([
    [85, -180],   // nördlichste, westlichste Ecke
    [-85, 180]    // südlichste, östlichste Ecke
  ]);


  // Hintergrund-Tiles laden
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a>',
    noWrap: true
  }).addTo(map);

  //Windkarten und Temperatur-Overlays
  //map-overlays definieren
  const overlays = {
  temp: L.tileLayer(`https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=${apiKey}`, { opacity: 0.6 }),
  clouds: L.tileLayer(`https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=${apiKey}`, { opacity: 0.6 }),
  precipitation: L.tileLayer(`https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=${apiKey}`, { opacity: 0.6 }),
  wind: L.tileLayer(`https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=${apiKey}`, { opacity: 0.6 })
  };
  const activeOverlays = {};
  
  // overlays togglebar machen
  function toggleOverlay(name) {
  if (activeOverlays[name]) {
    map.removeLayer(overlays[name]);
    delete activeOverlays[name];
  } else {
    overlays[name].addTo(map);
    activeOverlays[name] = true;
  }
  }

  const weatherData = JSON.parse('{{ weatherdata | tojson | safe }}');

  weatherData.forEach(city => {
    if (!city.error && city.coord) {
      const marker = L.marker([city.coord.lat, city.coord.lon]).addTo(map);

      // Popup mit Wetterinfos
      const popupContent = `
        <div class="wetter-box ${city.weather_class}">
            <strong>${city.name}</strong><br>
            ${city.weather_ger} – ${city.description}<br>
            🌡️ ${city.temp} °C<br>
            💧 ${city.humidity} %<br>
            <img src="http://openweathermap.org/img/wn/${city.icon}.png" alt="icon">
        </div>`;

      marker.bindPopup(popupContent);

      // Beim Klick: CSS-Klasse aktualisieren
      marker.on('click', () => {
        const mapContainer = document.getElementById('mapContainer');

        mapContainer.className = "map-container";  // Klassen zurücksetzen

        // Neue Wetterklasse basierend auf city.weather setzen
        const weatherClass = city.weather_class; // z.B. "clear-day"
        mapContainer.classList.add(weatherClass);
      });
    }
  });
  </script>
</body>
</html>